#include<stdio.h>
#include<malloc.h>
#include<string.h>
#include"base_struct.h"
#include"allfunc.h"
#include"fileopt.h"

//int year = 2020;
float sumcheck(int tag_check,float cost_term[])              //计算检查总费用函数
{
	int i ;
	float sum = 0;
	for (i = 0; i < tag_check; i++)
	{
		sum = sum + cost_term[i];
	}
	return sum;
}

float sumpill(int tag_pill, float cost_perpill[], int num_pill[])        //计算药品总费用函数
{
	int i;
	float sum = 0;
	for (i = 0; i < tag_pill ; i++)
	{
		sum = sum + ((cost_perpill[i]) * (num_pill[i]));
	}
	return sum;
}

int date_turn(int time,int year)                 //将4位日期转化为天数
{
	int mon, day, tag = 0;
	mon = time / 100;
	day = time % 100;
	switch (mon)
	{
	case 1:tag = day; break;
	case 2:tag = day + 31; break;
	case 3:tag = day + 59; break;
	case 4:tag = day + 90; break;
	case 5:tag = day + 120; break;
	case 6:tag = day + 151; break;
	case 7:tag = day + 181; break;
	case 8:tag = day + 212; break;
	case 9:tag = day + 243; break;
	case 10:tag = day + 273; break;
	case 11:tag = day + 304; break;
	case 12:tag = day + 334; break;
	}
	if ((judge_year(year)) && mon > 2)
		tag++;
	return tag;
}

//int days_hosp(int time_start, int time_end)                  //计算住院时长函数
//{
//	char ch1[8], ch2[8];
//	char x, y;
//	int durtime;
//	sprintf(ch1, "%d", time_start);
//	sprintf(ch2, "%d", time_end);
//	x = date_turn(ch1);
//	y = date_turn(ch2);
//	durtime = (((int)x) - ((int)y));
//	return durtime;
//}

int cost_hos(int in,int out,int now)           //住院费用函数
{
	if (out > now)
		return (now - in) * 100;
	else
		return (out - in) * 100;
}

record* getrecord(doctor* doc,pill_term* pill,che_term* che)    //录入记录
{
	record* temp = (record*)malloc(sizeof(record));
	temp->next = NULL;
	printf("请输入挂号\n");
	scanf("%d", &(temp->num_check)); getchar();
	printf("\n以下为输入患者信息，每条信息以回车结束\n\n请输入患者姓名：\n");
	scanf("%s", &(temp->pat.name_pat));getchar();
	while (!judge_name_pat(temp->pat.name_pat))
	{
		printf("姓名输入错误！请检查后重新输入！目前仅支持中文输入\n");
		scanf("%s", &(temp->pat.name_pat));getchar();
	}
	printf("性别：\n");
	scanf("%s", temp->pat.sex);getchar();
	while (!judge_sex(temp->pat.sex))
	{
		printf("性别输入错误！请检查后重新输入\n");
		scanf("%s", &(temp->pat.sex)); getchar();
	}
	printf("年龄：\n");
	scanf("%d", &temp->pat.age); getchar();
	while (!judge_age(temp->pat.age))
	{
		printf("年龄输入错误！请输入1-149的整数 输入小数将向下取证\n");
		scanf("%d", &temp->pat.age); getchar();
	}
	printf("身份证号后四位：\n");
	scanf("%s", temp->pat.tag_id);getchar();
	while (!judge_tag_id(temp->pat.sex, temp->pat.tag_id))
	{
		printf("身份证不符合规范！请检查后重新输入！尾数为x请小写\n");
		scanf("%s", temp->pat.tag_id); getchar();
	}
	printf("请输入医生工号：\n");
	scanf("%d", &temp->doc.num_work);getchar();
	doctor* tpdoc = judge_num_work(temp->doc.num_work, doc);
	while (tpdoc == NULL)
	{
		printf("工号不存在！请检查后重新输入\n");
		scanf("%d", &temp->doc.num_work); getchar();
		tpdoc = judge_num_work(temp->doc.num_work, doc);
	}
	strcpy(temp->doc.name_doc, tpdoc->name_doc);
	strcpy(temp->doc.level, tpdoc->level);
	strcpy(temp->doc.sub, tpdoc->sub);
	/*printf("输入就诊时间：\n");
	scanf("%s", temp->out_doc);getchar();*/
	strcpy(temp->out_doc , gettime());
	printf("请输入各项检查及其费用,输入“#”以结束\n");
	(temp->tre.che.tag_check) = 0; 
	bool flag_che = true; 
	int i = 0;
	while(flag_che)
	{
		printf("输入检查项目名称：\n");
		scanf("%s", &(temp->tre.che.type[i]));
		if (strcmp("#", temp->tre.che.type[i])==0)
		{
			flag_che = false;
			(temp->tre.che.cost_check) = sumcheck((temp->tre.che.tag_check), (temp->tre.che.cost_term));
			break;
		}
		else {
			che_term* tpche = judge_che_name(temp->tre.che.type[i],che);
			while (tpche==NULL) 
			{
				printf("该检查项目不存在！请检查后重新输入\n");
				scanf("%s", &(temp->tre.che.type[i]));
				if (strcmp("#", temp->tre.che.type[i]) == 0)
				{
					flag_che = false;
					(temp->tre.che.cost_check) = sumcheck((temp->tre.che.tag_check), (temp->tre.che.cost_term));
					break;
				}
				tpche = judge_che_name(temp->tre.che.type[i], che);
			}
			if(tpche!=NULL)
				temp->tre.che.cost_term[i] = tpche->che_price;
		}
		(temp->tre.che.tag_check)++;
		i++;
	}
	printf("请输入各药品名称及其数量和单价,输入“#”以结束\n");
	(temp->tre.pil.tag_pill) = 0; 
	bool flag_pil = true; 
	i = 0;
	while (flag_pil)
	{
		printf("输入药品名称：\n");
		scanf("%s", temp->tre.pil.name_pill[i]);
		if (strcmp("#", temp->tre.pil.name_pill[i])==0)
		{
			flag_pil = false;
			(temp->tre.pil.cost_pill) = sumpill(temp->tre.pil.tag_pill, temp->tre.pil.cost_perpill, temp->tre.pil.num_pill);
			break;
		}
		else
		{
			pill_term* tppill = judge_pill_name(temp->tre.pil.name_pill[i], pill);
			while (tppill==NULL)
			{
				printf("该药品名不存在！请检查后重新输入\n");
				scanf("%s", temp->tre.pil.name_pill[i]);
				if (strcmp("#", temp->tre.pil.name_pill[i]) == 0)
				{
					flag_pil = false;
					(temp->tre.pil.cost_pill) = sumpill(temp->tre.pil.tag_pill, temp->tre.pil.cost_perpill, temp->tre.pil.num_pill);
					break;
				}
					tppill = judge_pill_name(temp->tre.pil.name_pill[i], pill);
			}
			if(tppill!=NULL)
				temp->tre.pil.cost_perpill[i] = tppill->pill_price;
		}
		if (strcmp(temp->tre.pil.name_pill[i],"#")!=0) {
			printf("输入药品数量：\n");
			scanf("%d", &temp->tre.pil.num_pill[i]);
		}
		(temp->tre.pil.tag_pill)++;
		i++;
	}
	printf("\n请输入开始住院时间：\n");
	scanf("%04d", &(temp->tre.hos.time_start));
	printf("\n请输入预计出院时间：\n");
	scanf("%04d", &(temp->tre.hos.time_end));
	printf("\n请输入缴纳住院押金：\n");
	scanf("%d",&(temp->tre.hos.deposit));
	//(temp->tre.hos.days_hos) = days_hosp(temp->tre.hos.time_start, temp->tre.hos.time_end);
	printf("\n诊疗记录录入成功！\n");
	return temp;
}

void outpatient_tag(struct record* head)   //查找患者身份证号并输出
{
	char tag_in[5];
	printf("请输入患者身份证后四位：\n");
	scanf("%s", tag_in);
	record* p = head;
	while (p!= NULL)
	{
		if (strcmp(tag_in, p->pat.tag_id) == 0)
		{
			singleprint(p);
			p = p->next;
		}
		else
			p = p->next;
	}
	return;
}

void outpatient_name(struct record* head)		//检索患者姓名并输出
{
	char name[30];
	printf("请输入需要查询的患者姓名：\n");
	scanf("%s", &name);
	record* p;
	p = head; 
	int t, x = 0,m = 0;
	while (strcmp((p->pat.name_pat) , name) == 0&& p != NULL)
	{
		x = x + 1;
		printf("%d %s %d %s\n", x, ((p->pat).name_pat), ((p->pat).age),p->pat.tag_id);//输出患者信息部分
		p = p->next;
	}
	if (x == 0)
	{
		printf("查无此人！\n");
		return;
	}
	printf("请输入需要查询的患者序号：\n");
	scanf("%d", &t);
	for (strcmp((p->pat.name_pat), name) == 1; p != NULL; )
	{
		m = m + 1;
		if (m == t) 
		{
			printf("%s %d ", (p->pat.name_pat), (p->pat.age));//输出患者信息部分
			printf("%s %s %s %d ", p->doc.name_doc, p->doc.level, p->doc.sub, p->doc.num_work);//输出医生信息部分
			printf("%s ", p->out_doc);                         //输出出诊时间
			for (int i = 0; i < (p->tre.che.tag_check); i++)
			{
				printf("%s ", p->tre.che.type[i]);       //输出检查类型
				printf("%f ", p->tre.che.cost_term[i]);  //输出单项检查的费用
			}
			for (int i = 0; i < (p->tre.pil.tag_pill); i++)
			{
				printf("%s ", p->tre.pil.name_pill[i]);   //输出药品名称
				printf("%d ", p->tre.pil.cost_perpill[i]);//输出药品单价
				printf("%d ", p->tre.pil.num_pill[i]);    //输出药品数量
			}
			printf("%d  %d ", p->tre.hos.time_start, p->tre.hos.time_end);//输出住,出院时间
			printf("%d %d %d\n", p->tre.hos.days_hos, p->tre.hos.cost_hos, p->tre.hos.deposit);//输出住院天数,住院费用,住院押金
		}
	}
	return;
}

void outsub_doc(struct record* head)   //科室检索
{
	char sub_in[10];
	record* p = head;
	printf("请输入需要查询的科室\n");
	scanf("%s", sub_in);
	while (p != NULL)
	{
		if (strcmp(sub_in, p->doc.sub) == 0)
		{
			singleprint(p);
			p = p->next;
		}
		else
			p = p->next;
	}
}

void outname_doc(struct record* head)  //医生工号检索
{
	int num;
	record* p = head; 
	printf("请输入需要查询的医生工号\n");
	scanf("%d", &num);
	while (p != NULL)
	{
		if (p->doc.num_work == num)
		{
			singleprint(p);
			p = p->next;
		}
		else
			p = p->next;
	}
}

//void outtime_limit(struct record* head)        //时间段检索
//{
//	record* p, * q;
//	p = head; q = p->next;
//	char time_start[8], time_end[8];
//	int start, end, tag_time;
//	printf("请输入起始时间以及结束时间：\n");
//	scanf("%s%s", &time_start, &time_end);
//	start = date_turn(time_start); end = date_turn(time_end);
//	
//	int t, x = 0; t = 0;
//	for (q != NULL;;) 
//	{
//		tag_time=date_turn(p->out_doc);
//		for ((tag_time>=start)&&(tag_time<=end);;)
//	    {
//		    printf("%s ", p->out_doc);                         //输出出诊时间
//		    printf("%d %s %s %s", p->doc.num_work, p->doc.name_doc, p->doc.sub, p->doc.level);//输出医生信息部分
//		    printf("%s %d ", (p->pat.name_pat), (p->pat.age));//输出患者信息部分
//		    for (int i = 0; i < (p->tre.che.tag_check); i++)
//		    {
//			    printf("%s ", p->tre.che.type[i]);       //输出检查类型
//			    printf("%f ", p->tre.che.cost_term[i]);  //输出单项检查的费用
//		    }
//		    for (int i = 0; i < (p->tre.pil.tag_pill); i++)
//		    {
//			    printf("%s ", p->tre.pil.name_pill[i]);   //输出药品名称
//			    printf("%d ", p->tre.pil.cost_perpill[i]);//输出药品单价
//			    printf("%d ", p->tre.pil.num_pill[i]);    //输出药品数量
//		    }
//		    printf("%d  %d ", p->tre.hos.time_start, p->tre.hos.time_end);//输出住,出院时间
//		    printf("%d %d %d\n", p->tre.hos.days_hos, p->tre.hos.cost_hos, p->tre.hos.deposit);//输出住院天数,住院费用,住院押金
//	    }
//	}
//	return;
//}

//void output(struct record* head)
//{
//	record* p, * q;
//	p = head; q = p->next;
//	int x; x = 0;
//	while (p->next!=NULL)
//	{
//		x = x + 1;
//		printf("%d ", x);
//		printf("%s %d ", (p->pat.name_pat), (p->pat.age));//输出患者信息部分
//		printf("%s %s %s %d ", p->doc.name_doc, p->doc.level, p->doc.sub, p->doc.num_work);//输出医生信息部分
//		printf("%s ", p->out_doc);                         //输出出诊时间
//		for (int i = 0; i < (p->tre.che.tag_check); i++)
//		{
//			printf("%s ", p->tre.che.type[i]);       //输出检查类型
//			printf("%f ", p->tre.che.cost_term[i]);  //输出单项检查的费用
//		}
//		for (int i = 0; i < (p->tre.pil.tag_pill); i++)
//		{
//			printf("%s ", p->tre.pil.name_pill[i]);   //输出药品名称
//			printf("%d ", p->tre.pil.cost_perpill[i]);//输出药品单价
//			printf("%d ", p->tre.pil.num_pill[i]);    //输出药品数量
//		}
//		printf("%d  %d ", p->tre.hos.time_start, p->tre.hos.time_end);//输出住,出院时间
//		printf("%d %d %d\n", p->tre.hos.days_hos, p->tre.hos.cost_hos, p->tre.hos.deposit);//输出住院天数,住院费用,住院押金
//		if (p->next== NULL)
//			return;
//		else
//			p = p->next; 
//		
//	}
//	return;
//}

void del_record(record* head,record* t)   //删除操作
{
	record* p = head;
	record* pre = NULL;
	while (p != NULL && p != t) {
		p = p->next;
		pre = p;
	}
	if (p == t) {
		pre->next = p->next;
		free(p);
		printf("删除成功！");
	}
}

//void input(struct record* p)
//{
//	printf("请输入患者信息\n");
//	scanf("%s%d", &(p->pat.name_pat), &(p->pat.age));
//	printf("请输入挂号\n");
//	scanf("%d", &(p->num_check));
//	printf("请输入医生信息\n");
//	scanf("%s%s%s%d", &(p->doc.name_doc), &(p->doc.level), &(p->doc.sub), &(p->doc.num_work));
//	printf("请输入出诊时间\n");
//	scanf("%s", &(p->out_doc[8]));
//	printf("请输入各项检查及其费用,若输入结束请键入‘|’\n");
//	(p->tre.che.tag_check) = 0; bool flag_che = true; int i = 0;
//	while (flag_che)
//	{
//		scanf("%s", &(p->tre.che.type[i]));
//		if ((p->tre.che.type[i][0]) == '|')
//		{
//			flag_che = false;
//			(p->tre.che.cost_check) = sumcheck((p->tre.che.tag_check), (p->tre.che.cost_term));
//			break;
//		}
//		scanf("%f", &(p->tre.che.cost_term[i]));
//		(p->tre.che.tag_check)++;
//	}
//	printf("请输入各药品名称及其数量和单价,若输入结束请键入‘|’\n");
//	(p->tre.pil.tag_pill) = 0; bool flag_pil = true; i = 0;
//	while (flag_pil)
//	{
//		scanf("%s", &(p->tre.pil.name_pill[i]));
//		if ((p->tre.pil.name_pill[i][0]) == '|')
//		{
//			flag_pil = false;
//			(p->tre.pil.cost_pill) = sumpill(p->tre.pil.tag_pill, p->tre.pil.cost_perpill, p->tre.pil.num_pill);
//			break;
//		}
//		scanf("%d%d", &(p->tre.pil.cost_perpill[i]), &(p->tre.pil.num_pill[i]));
//		(p->tre.pil.tag_pill)++;
//	}
//	printf("请输入开始住院时间，预计出院时间及已交纳的住院押金\n");
//	scanf("%d%d%d", &(p->tre.hos.time_start), &(p->tre.hos.time_end), &(p->tre.hos.deposit));
//	(p->tre.hos.days_hos) = days_hosp(p->tre.hos.time_start, p->tre.hos.time_end);
//	return;
//}

void alter_record(record* head,record* t,doctor* doc,pill_term* pill,che_term* che)   //修改操作
{
	record* p = head;
	record* pre = NULL;
	record* after = NULL;
	while (p != NULL && p != t)
	{
		p = p->next;
		pre = p;
	}
	if (p == t)
	{
		int tp = p->num_check;//暂时保存挂号
		after = p->next;
		printf("请重新输入诊疗记录！\n");
		p = getrecord(doc, pill, che);
		p->num_check = tp;
		pre->next = p;
		p->next = after;
		printf("诊疗记录修改成功！\n");
	}
}

void statistics(record* head)    //营业额
{
	float turn = 0;
	record* p = head; 
	while (p != NULL)
	{
		turn = turn+ (p->tre.che.cost_check) + (p->tre.pil.cost_pill) + (float)(p->tre.hos.cost_hos);
		p = p->next;
	}
	printf("医院现有资金：%.2d元", turn);
}

void yearchange(int a) {                              //改变系统年份
	printf("请输入目标年份：");
	scanf("%d", &a);
	return;
}

bool judge_year(int a) {                             //判断闰年
	if (a % 100 == 0) {
		if (a % 400 == 0) {
			return true;
		}
		return false;
	}
	else {
		if (a % 4 == 0 && a % 100 != 0) {
			return true;
		}
		return false;
	}
}

bool judge_name_pat(char* name) {                 //判断姓名
	bool flag = true;
	int i = 0;
	while (name[i] != '\0') {
		if (name[i] >= 0) {
			flag = false;
			break;
		}
		i++;
	}
	return flag;
}

bool judge_age(int age) {                            //判断年龄
	if (age < 0 || age > 150) {
		return false;
	}
	else
		return true;
}

bool judge_sex(char* sex) {                        //判断性别
	if (strcmp(sex, "男") != 0 && strcmp(sex, "女") != 0) {
		return false;
	}
	else
		return true;
}

bool judge_tag_id(char* sex,char* id) {                         //判断身份证尾号
	int t = 0;
	bool flag = true;
	for (t = 0; t < 3; t++) {
		if ((id[t]) <= '0' || (id[t]) >= '9') {
			flag=false;
			return flag;
		}
	}
	if (id[3] <= '0' || id[3] >= '9') {
		flag = false;
		if (id[3] == 'x')
			flag = true;
	}
	if (strcmp(sex, "男") == 0 && (id[2]) % 2 == 0) {
		flag=false;
	}
	if (strcmp(sex, "女") == 0 && (id[2]) % 2 != 0) {
		flag=false;
	}
	return flag;
}

bool judge_num_check(record* p) {                  //判断挂号
	record* a, * b;
	char x[8];
	int m;
	a = p; b = p->next;
	while (b->next != NULL) {
		b = b->next;
	}
	while (a != b) {
		if (a->num_check == b->num_check) {
			return false;
		}
		a = a->next;
	}
	sprintf(x, "%d", b->num_check);
	m = (x[0] * 10) + x[1];
	if (m > 12 || m < 1) {
		return false;
	}
	m = (x[4] * 100) + (x[5] * 10) + x[6];
	if (m < 1 || m>500) {
		return false;
	}
	return true;
}

che_term* judge_che_name(char* p, che_term* q) {				 //判断检查名称是否正确
	bool flag = false;
	while (q != NULL) {
		if (strcmp(p, q->che_name) == 0)
			return q;
		q = q->next;
	}
	return NULL;
}

pill_term* judge_pill_name(char* p, pill_term* q) {               //判断药品名称是否正确
	while (q != NULL) {
		if (strcmp(p, q->pill_name) == 0)
			return q;
		q = q->next;
	}
	return NULL;
}

doctor* judge_num_work(int num, doctor* s) {					//判断医生工号
	while (s != NULL) {
		if (num == s->num_work)
			return s;
		s = s->next;
	}
	return NULL;
}

bool time(int a, int b) {                             //判断时间
	char m[9]; int x, y, i, j;
	sprintf(m, "%d", a);
	x = (m[0] * 10) + m[1];
	y = (m[2] * 10) + m[3];
	i = (m[4] * 10) + m[5];
	j = (m[6] * 10) + m[7];
	if (x < 1 || x > 12 || y < 1 || i > 24 || j > 59) {
		return false;
	}
	if (x == 1 || x == 3 || x == 5 || x == 7 || x == 8 || x == 10 || x == 12) {
		if (y > 31) {
			return false;
		}
	}
	if (x == 2 || x == 4 || x == 6 || x == 9 || x == 11) {
		if (y > 30) {
			return false;
		}
	}
	if (judge_year(b)) {
		if (x == 2 || y > 29) {
			return false;
		}
	}
	else {
		if (x == 2 || y > 28) {
			return false;
		}
	}
	return true;
}

//bool judge_time(record* p) {
//	if (!(time(p->tre.hos.time_start, year))) {
//		return false;
//	}
//	if (!(time(p->tre.hos.time_end, year))) {
//		return false;
//	}
//	if (days_hosp(p->tre.hos.time_start, p->tre.hos.time_end) < 1) {
//		return false;
//	}
//	return true;
//}